#!/bin/bash
# reflect - Work reflection generator from GitHub activity
#
# Usage:
#   reflect                    Generate reflection since last run
#   reflect --since 2025-01-01 Generate reflection since specific date
#   reflect --days 7           Generate reflection for last N days
#   reflect --dry-run          Show what would be collected without generating
#   reflect --setup            Set up the work-journal repo
#
# Environment variables:
#   REFLECT_ORG       - GitHub org to track (default: github)
#   REFLECT_REPO      - Journal repo (default: work-journal)
#   REFLECT_AGENT_CMD - Agent command (default: copilot)

set -e

# ═══════════════════════════════════════════════════════════════════════════
# Configuration
# ═══════════════════════════════════════════════════════════════════════════

REFLECT_ORG="${REFLECT_ORG:-github}"
REFLECT_REPO="${REFLECT_REPO:-work-journal}"
AGENT_CMD="${REFLECT_AGENT_CMD:-copilot --yolo}"
REFLECT_DATA_DIR="$HOME/.ralph/reflect"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# ═══════════════════════════════════════════════════════════════════════════
# Helper functions
# ═══════════════════════════════════════════════════════════════════════════

print_header() {
  echo ""
  echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
  echo -e "${BLUE}  $1${NC}"
  echo -e "${BLUE}═══════════════════════════════════════════════════════${NC}"
}

print_status() {
  echo -e "${GREEN}[reflect]${NC} $1"
}

print_warning() {
  echo -e "${YELLOW}[reflect]${NC} $1"
}

print_error() {
  echo -e "${RED}[reflect]${NC} $1"
}

usage() {
  echo "reflect - Work reflection generator from GitHub activity"
  echo ""
  echo "Usage:"
  echo "  reflect                    Generate reflection since last run"
  echo "  reflect --since 2025-01-01 Generate reflection since specific date"
  echo "  reflect --days 7           Generate reflection for last N days"
  echo "  reflect --dry-run          Show data without generating reflection"
  echo "  reflect --setup            Set up the work-journal repo"
  echo ""
  echo "Environment variables:"
  echo "  REFLECT_ORG       GitHub org to track (default: github)"
  echo "  REFLECT_REPO      Journal repo (default: work-journal)"
  echo "  REFLECT_AGENT_CMD Agent command (default: copilot)"
  exit 1
}

# ═══════════════════════════════════════════════════════════════════════════
# Setup command
# ═══════════════════════════════════════════════════════════════════════════

setup_repo() {
  print_header "Setting up work-journal repo"

  local username
  username=$(gh api user --jq '.login')

  print_status "GitHub user: $username"
  print_status "Repo: $username/$REFLECT_REPO"

  # Check if repo exists
  if gh repo view "$username/$REFLECT_REPO" &>/dev/null; then
    print_status "Repo already exists"
  else
    print_status "Creating private repo..."
    gh repo create "$REFLECT_REPO" --private --description "Work reflections and career journal"

    # Clone and set up initial structure
    local tmp_dir
    tmp_dir=$(mktemp -d)
    cd "$tmp_dir"
    gh repo clone "$username/$REFLECT_REPO"
    cd "$REFLECT_REPO"

    # Create initial structure
    mkdir -p reflections

    cat >README.md <<'EOF'
# Work Journal

Private repository for tracking work reflections and career growth.

## Structure

- `reflections/` - Generated reflections from `reflect` command
- `config.md` - Company values and staff engineer qualities (customize this)

## Usage

```bash
# Generate a reflection
reflect

# Generate since specific date
reflect --since 2025-01-01
```
EOF

    cat >config.md <<'EOF'
# Reflection Configuration

## Company Values

<!-- Customize these with your company's actual values -->
- **Collaboration** - Work effectively with others across teams
- **Customer Focus** - Prioritize customer needs and outcomes
- **Quality** - Maintain high standards in everything we ship
- **Innovation** - Find creative solutions to hard problems
- **Transparency** - Communicate openly and honestly

## Staff Engineer Qualities

<!-- Customize these with your company's staff engineer expectations -->
- **Technical Leadership** - Drive technical direction and mentor others
- **Cross-team Impact** - Work that benefits multiple teams or the org
- **System Thinking** - Understand and improve complex systems
- **Communication** - Explain complex topics clearly to various audiences
- **Influence** - Shape decisions through expertise, not authority
- **Delivery** - Consistently ship high-quality work
- **Mentorship** - Help others grow and develop

## Reflection Prompts

When reflecting, consider:
1. What was the business impact of this work?
2. Who did I help or collaborate with?
3. What did I learn?
4. What would I do differently?
5. How does this demonstrate staff-level work?
EOF

    git add .
    git commit -m "Initial setup"
    git push

    cd /
    rm -rf "$tmp_dir"

    print_status "Repo created and initialized"
  fi

  # Create local data directory
  mkdir -p "$REFLECT_DATA_DIR"

  print_status "Setup complete!"
  print_status ""
  print_status "Next steps:"
  print_status "1. Edit config.md in $username/$REFLECT_REPO to customize values"
  print_status "2. Run 'reflect --since 2025-01-01' to generate your first reflection"

  exit 0
}

# ═══════════════════════════════════════════════════════════════════════════
# Data collection functions
# ═══════════════════════════════════════════════════════════════════════════

get_username() {
  gh api user --jq '.login'
}

# Get PRs authored and merged
get_merged_prs() {
  local since="$1"
  local username="$2"

  gh search prs \
    --author="$username" \
    --merged=">=$since" \
    --owner="$REFLECT_ORG" \
    --json title,url,repository,mergedAt,additions,deletions,body \
    --limit 100 2>/dev/null || echo "[]"
}

# Get PRs authored and opened (not yet merged)
get_opened_prs() {
  local since="$1"
  local username="$2"

  gh search prs \
    --author="$username" \
    --created=">=$since" \
    --state=open \
    --owner="$REFLECT_ORG" \
    --json title,url,repository,createdAt,additions,deletions \
    --limit 100 2>/dev/null || echo "[]"
}

# Get PRs reviewed
get_reviews_given() {
  local since="$1"
  local username="$2"

  gh search prs \
    --reviewed-by="$username" \
    --updated=">=$since" \
    --owner="$REFLECT_ORG" \
    --json title,url,repository,author \
    --limit 100 2>/dev/null || echo "[]"
}

# Get issues closed
get_issues_closed() {
  local since="$1"
  local username="$2"

  gh search issues \
    --assignee="$username" \
    --closed=">=$since" \
    --owner="$REFLECT_ORG" \
    --json title,url,repository,closedAt \
    --limit 100 2>/dev/null || echo "[]"
}

# Get commits (this is trickier - we'll use search)
get_commits() {
  local since="$1"
  local username="$2"

  gh search commits \
    --author="$username" \
    --author-date=">=$since" \
    --owner="$REFLECT_ORG" \
    --json repository,sha,commit \
    --limit 200 2>/dev/null || echo "[]"
}

# ═══════════════════════════════════════════════════════════════════════════
# Main logic
# ═══════════════════════════════════════════════════════════════════════════

# Parse arguments
SINCE_DATE=""
DRY_RUN=false
DAYS=""

while [[ $# -gt 0 ]]; do
  case $1 in
  --since)
    SINCE_DATE="$2"
    shift 2
    ;;
  --days)
    DAYS="$2"
    shift 2
    ;;
  --dry-run)
    DRY_RUN=true
    shift
    ;;
  --setup)
    setup_repo
    ;;
  -h | --help)
    usage
    ;;
  *)
    print_error "Unknown option: $1"
    usage
    ;;
  esac
done

# Ensure data directory exists
mkdir -p "$REFLECT_DATA_DIR"

# Determine the since date
LAST_RUN_FILE="$REFLECT_DATA_DIR/last-run"

if [ -n "$SINCE_DATE" ]; then
  # Explicit --since provided
  SINCE="$SINCE_DATE"
elif [ -n "$DAYS" ]; then
  # --days provided
  SINCE=$(date -d "$DAYS days ago" +%Y-%m-%d 2>/dev/null || date -v-${DAYS}d +%Y-%m-%d)
elif [ -f "$LAST_RUN_FILE" ]; then
  # Use last run date
  SINCE=$(cat "$LAST_RUN_FILE")
else
  # First run - default to 7 days
  print_warning "First run detected. Defaulting to last 7 days."
  print_warning "Use --since YYYY-MM-DD to specify a different start date."
  SINCE=$(date -d "7 days ago" +%Y-%m-%d 2>/dev/null || date -v-7d +%Y-%m-%d)
fi

print_header "Generating Reflection"
print_status "Organization: $REFLECT_ORG"
print_status "Since: $SINCE"
print_status "Until: $(date +%Y-%m-%d)"

# Get username
USERNAME=$(get_username)
print_status "User: $USERNAME"

# Collect data
print_status "Collecting GitHub activity..."

echo -n "  PRs merged... "
MERGED_PRS=$(get_merged_prs "$SINCE" "$USERNAME")
MERGED_COUNT=$(echo "$MERGED_PRS" | jq 'length')
echo "$MERGED_COUNT"

echo -n "  PRs opened... "
OPENED_PRS=$(get_opened_prs "$SINCE" "$USERNAME")
OPENED_COUNT=$(echo "$OPENED_PRS" | jq 'length')
echo "$OPENED_COUNT"

echo -n "  Reviews given... "
REVIEWS=$(get_reviews_given "$SINCE" "$USERNAME")
REVIEWS_COUNT=$(echo "$REVIEWS" | jq 'length')
echo "$REVIEWS_COUNT"

echo -n "  Issues closed... "
ISSUES=$(get_issues_closed "$SINCE" "$USERNAME")
ISSUES_COUNT=$(echo "$ISSUES" | jq 'length')
echo "$ISSUES_COUNT"

echo -n "  Commits... "
COMMITS=$(get_commits "$SINCE" "$USERNAME")
COMMITS_COUNT=$(echo "$COMMITS" | jq 'length')
echo "$COMMITS_COUNT"

# Get unique repos contributed to
REPOS=$(echo "$MERGED_PRS $OPENED_PRS $COMMITS" | jq -s 'add | [.[].repository.name] | unique | sort' 2>/dev/null || echo "[]")
REPOS_COUNT=$(echo "$REPOS" | jq 'length')

print_status "Repos contributed to: $REPOS_COUNT"

# If dry run, just show the data
if [ "$DRY_RUN" = true ]; then
  print_header "Data Summary (Dry Run)"

  echo ""
  echo -e "${BOLD}PRs Merged ($MERGED_COUNT):${NC}"
  echo "$MERGED_PRS" | jq -r '.[] | "  - [\(.repository.name)] \(.title)"' 2>/dev/null || echo "  (none)"

  echo ""
  echo -e "${BOLD}PRs Opened ($OPENED_COUNT):${NC}"
  echo "$OPENED_PRS" | jq -r '.[] | "  - [\(.repository.name)] \(.title)"' 2>/dev/null || echo "  (none)"

  echo ""
  echo -e "${BOLD}Reviews Given ($REVIEWS_COUNT):${NC}"
  echo "$REVIEWS" | jq -r '.[] | "  - [\(.repository.name)] \(.title) (by @\(.author.login))"' 2>/dev/null || echo "  (none)"

  echo ""
  echo -e "${BOLD}Issues Closed ($ISSUES_COUNT):${NC}"
  echo "$ISSUES" | jq -r '.[] | "  - [\(.repository.name)] \(.title)"' 2>/dev/null || echo "  (none)"

  echo ""
  echo -e "${BOLD}Repos:${NC}"
  echo "$REPOS" | jq -r '.[] | "  - \(.)"' 2>/dev/null || echo "  (none)"

  exit 0
fi

# Check if journal repo exists
JOURNAL_REPO="$USERNAME/$REFLECT_REPO"
if ! gh repo view "$JOURNAL_REPO" &>/dev/null; then
  print_error "Journal repo not found: $JOURNAL_REPO"
  print_error "Run 'reflect --setup' to create it."
  exit 1
fi

# Get config from journal repo
print_status "Loading config from journal repo..."
CONFIG=$(gh api "repos/$JOURNAL_REPO/contents/config.md" --jq '.content' 2>/dev/null | base64 -d 2>/dev/null || echo "")

if [ -z "$CONFIG" ]; then
  print_warning "No config.md found in journal repo. Using defaults."
  CONFIG="Use company values and staff engineer qualities to frame accomplishments."
fi

# Generate reflection with LLM
print_header "Generating Reflection with AI"

REFLECTION_DATE=$(date +%Y-%m-%d)
REFLECTION_FILE="reflections/$REFLECTION_DATE.md"

# Build the prompt
read -r -d '' PROMPT <<PROMPT_END || true
You are helping a software engineer write a work reflection for the period from $SINCE to $REFLECTION_DATE.

# Company Context & Values

$CONFIG

# GitHub Activity Data

## PRs Merged ($MERGED_COUNT)
$(echo "$MERGED_PRS" | jq -r '.[] | "- **[\(.repository.name)]** \(.title)\n  URL: \(.url)\n  +\(.additions)/-\(.deletions) lines"' 2>/dev/null || echo "(none)")

## PRs Opened (In Progress) ($OPENED_COUNT)
$(echo "$OPENED_PRS" | jq -r '.[] | "- **[\(.repository.name)]** \(.title)\n  URL: \(.url)"' 2>/dev/null || echo "(none)")

## Code Reviews Given ($REVIEWS_COUNT)
$(echo "$REVIEWS" | jq -r '.[] | "- **[\(.repository.name)]** \(.title) (by @\(.author.login))\n  URL: \(.url)"' 2>/dev/null || echo "(none)")

## Issues Closed ($ISSUES_COUNT)
$(echo "$ISSUES" | jq -r '.[] | "- **[\(.repository.name)]** \(.title)\n  URL: \(.url)"' 2>/dev/null || echo "(none)")

## Repositories Contributed To
$(echo "$REPOS" | jq -r '.[]' 2>/dev/null || echo "(none)")

# Your Task

Write a reflection document in markdown format. The reflection should:

1. **Summary** (2-3 sentences) - High-level overview of what was accomplished
2. **Key Accomplishments** - Group related work together, explain the business impact
3. **Technical Leadership** - Highlight any cross-team work, mentorship (reviews), or architectural decisions
4. **Alignment with Values** - Connect work to company values where relevant
5. **Staff-Level Indicators** - Call out work that demonstrates staff engineer qualities
6. **Learnings** - What was learned or what would be done differently
7. **Looking Ahead** - What's in progress or coming next (based on open PRs)

## Format

\`\`\`markdown
# Reflection: $SINCE to $REFLECTION_DATE

## Summary
[2-3 sentence overview]

## Key Accomplishments

### [Theme/Project 1]
- What was done
- **Business Impact:** Why it matters
- Related PRs: [links]

### [Theme/Project 2]
...

## Technical Leadership
- Code reviews and mentorship
- Cross-team collaboration
- Architectural decisions

## Alignment with Values
- [Value]: How work demonstrated this

## Staff-Level Indicators
- [Quality]: Evidence

## Learnings
- What was learned
- What would be done differently

## In Progress
- Work that's still ongoing
\`\`\`

## Important

- Be specific and quantitative where possible
- Focus on IMPACT, not just activity
- Group related items together (don't just list PRs)
- Use the actual PR titles and details provided
- Keep it professional but personable
- This will be used for performance reviews, so highlight achievements
PROMPT_END

print_status "Generating reflection..."

# Run the agent and capture output
REFLECTION=$(echo "$PROMPT" | $AGENT_CMD 2>&1)

# Extract just the markdown content (between ```markdown and ```)
REFLECTION_CONTENT=$(echo "$REFLECTION" | sed -n '/^```markdown/,/^```$/p' | sed '1d;$d')

# If no markdown block found, use the whole output
if [ -z "$REFLECTION_CONTENT" ]; then
  REFLECTION_CONTENT="$REFLECTION"
fi

# Save to journal repo
print_status "Saving to journal repo..."

# Clone, add file, push
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"
gh repo clone "$JOURNAL_REPO" repo --depth 1
cd repo

mkdir -p reflections

echo "$REFLECTION_CONTENT" >"$REFLECTION_FILE"

git add "$REFLECTION_FILE"
git commit -m "Add reflection for $SINCE to $REFLECTION_DATE"
git push

cd /
rm -rf "$TEMP_DIR"

# Update last run date
echo "$REFLECTION_DATE" >"$LAST_RUN_FILE"

print_header "Reflection Complete"
echo ""
echo -e "${BOLD}Saved to:${NC} $JOURNAL_REPO/$REFLECTION_FILE"
echo ""
echo -e "${CYAN}View:${NC} gh repo view $JOURNAL_REPO --web"
echo ""

# Show preview
echo -e "${BOLD}Preview:${NC}"
echo "─────────────────────────────────────────────────────"
echo "$REFLECTION_CONTENT" | head -40
if [ $(echo "$REFLECTION_CONTENT" | wc -l) -gt 40 ]; then
  echo "..."
  echo "(truncated - see full reflection in repo)"
fi
echo "─────────────────────────────────────────────────────"
