#!/bin/bash

set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() { echo -e "${GREEN}[INFO]${NC} $1"; }
print_warning() { echo -e "${YELLOW}[WARN]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }
print_header() { echo -e "${BLUE}=== $1 ===${NC}"; }

# Check if 1Password CLI is already installed
if command -v op >/dev/null 2>&1; then
  print_status "1Password CLI is already installed"
  op --version
  exit 0
fi

# Detect OS
if [[ "$OSTYPE" == "darwin"* ]]; then
  OS="macos"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
  OS="linux"
else
  print_error "Unsupported operating system: $OSTYPE"
  exit 1
fi

print_header "Installing 1Password CLI"

if [[ "$OS" == "macos" ]]; then
  # macOS installation via Homebrew
  print_status "Installing 1Password CLI via Homebrew on macOS..."

  # Check if homebrew is available
  if ! command -v brew >/dev/null 2>&1; then
    print_error "Homebrew is required but not installed. Please install Homebrew first."
    exit 1
  fi

  brew install 1password-cli

elif [[ "$OS" == "linux" ]]; then
  # Linux installation via direct download
  print_status "Installing 1Password CLI on Linux..."

  if command -v apt >/dev/null 2>&1; then
    print_status "Debian/Ubuntu detected. Installing via apt repository..."

    # Check if required tools are available
    for tool in curl tee gpg; do
      if ! command -v "$tool" >/dev/null 2>&1; then
        print_error "$tool is required but not installed. Please install it first."
        exit 1
      fi
    done

    # Add the key for the 1Password apt repository
    print_status "Adding 1Password repository and key..."
    curl -sS https://downloads.1password.com/linux/keys/1password.asc |
      sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg

    # Add the 1Password apt repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" |
      sudo tee /etc/apt/sources.list.d/1password.list

    # Add the debsig-verify policy
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol |
      sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc |
      sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg

    # Install the 1Password CLI
    print_status "Updating package lists and installing 1Password CLI..."
    sudo apt update && sudo apt install 1password-cli

  else
    print_error "Unsupported Linux distribution. Please install 1Password CLI manually from https://1password.com/downloads/command-line/"
    exit 1
  fi
fi

print_status "âœ“ 1Password CLI installed successfully"
