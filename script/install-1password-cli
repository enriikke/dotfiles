#!/usr/bin/env bash

set -e

# Source shared helpers
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=script/common.sh
. "$script_dir/common.sh"

# Check if 1Password CLI is already installed
if command -v op >/dev/null 2>&1; then
  print_status "1Password CLI is already installed"
  op --version
  exit 0
fi

# Detect OS via common helper
if ! OS="$(detect_os)"; then
  print_error "Unsupported operating system: $OSTYPE"
  exit 1
fi

print_header "Installing 1Password CLI"

if [[ $OS == "macos" ]]; then
  # macOS installation via Homebrew
  print_status "Installing 1Password CLI via Homebrew on macOS..."

  # Check if homebrew is available
  if ! command -v brew >/dev/null 2>&1; then
    print_error "Homebrew is required but not installed. Please install Homebrew first."
    exit 1
  fi

  brew install 1password-cli

elif [[ $OS == "linux" ]]; then
  # Linux installation via direct download
  print_status "Installing 1Password CLI on Linux..."

  if command -v apt >/dev/null 2>&1; then
    print_status "Debian/Ubuntu detected. Installing via apt repository..."

    # Check if required tools are available
    if ! require_cmds curl tee gpg; then
      print_error "Required tools missing. Please install the missing commands and re-run."
      exit 1
    fi

    # Add the key for the 1Password apt repository
    print_status "Adding 1Password repository and key..."
    curl -sS https://downloads.1password.com/linux/keys/1password.asc |
      sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg

    # Add the 1Password apt repository
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main" |
      sudo tee /etc/apt/sources.list.d/1password.list

    # Add the debsig-verify policy
    sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/
    curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol |
      sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol
    sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22
    curl -sS https://downloads.1password.com/linux/keys/1password.asc |
      sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg

    # Install the 1Password CLI
    print_status "Updating package lists and installing 1Password CLI..."
    sudo apt update && sudo apt install 1password-cli

  else
    print_error "Unsupported Linux distribution. Please install 1Password CLI manually from https://1password.com/downloads/command-line/"
    exit 1
  fi
fi

print_status "âœ“ 1Password CLI installed successfully"
