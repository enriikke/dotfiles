#!/bin/bash

set -x

# where am i?
# WD=$(pwd -P)
# if [ ! -f "$WD/script/setup" ]; then
#   echo "whoa there! please run me from the root of the repo ‚ò∫Ô∏è"
#   exit 1
# fi

if [ -L "$0" ]; then
  DIR=$(dirname $(readlink -f $0))
else
  DIR=$(dirname $0)
fi

WD=$(pwd)
cd $DIR/..
ROOT=$(pwd)
cd $WD

# are we on a mac or GH codespace? bootstrap!
if [ $(uname -s) = "Darwin" ]; then
  $ROOT/script/bootstrap-mac
else
  sudo apt-get update
  sudo apt-get install -y ctags fzf gh git httpie imagemagick jq neovim ripgrep tmux tree wget zsh
fi

# copy dotfiles
mkdir -p ~/.config
ln -sfv $ROOT/dots/config/nvim ~/.config/nvim
ln -sfv $ROOT/dots/config/zsh ~/.config/zsh
ln -sfv $ROOT/dots/gitconfig ~/.gitconfig
ln -sfv $ROOT/dots/gitignore ~/.gitignore
ln -sfv $ROOT/dots/tmux.conf ~/.tmux.conf
ln -sfv $ROOT/dots/zshrc ~/.zshrc


# install antibody (zsh plugin manager)
# https://getantibody.github.io
curl -sfL git.io/antibody | sudo sh -s - -b /usr/local/bin

# install vim-plug (vim plugin manager)
# https://github.com/junegunn/vim-plug
sh -c 'curl -fLo "${XDG_DATA_HOME:-$HOME/.local/share}"/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'
# nvim +PlugInstall +qall

# change default shell to zsh
if [ "$SHELL" != $(which zsh) ]; then
  sudo chsh -s $(which zsh)
fi

# load zsh and install plugins
# source ~/.zshrc

# done
if [ -n $CODESPACES ]; then
  # send notification that dotfiles setup has completed
  curl --silent \
    --form-string "token=$PUSHOVER_API_TOKEN" \
    --form-string "user=$PUSHOVER_USER_KEY" \
    --form-string "message=üéâ Codespace $CODESPACE_NAME is ready! ‚ú®" \
    https://api.pushover.net/1/messages.json
fi
